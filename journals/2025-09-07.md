---
tags:
  - "#📅"
---
## Hvordan ser dagen ud? (aftaler)


## Hvad vil jeg gerne opnå i dag ?


## Hvordan gik dagen?
### [[2508_AITolkLaunch]] Fix: Github Auto deply
* Fix automatisk deploy af ai tolk appen når der er et nyt release
#### Opret GITHub servicekonto `fjeldmann_deploybot`
* På Simply.com opret alias `github_deploybot@fjeldmann.dk` til `contact@fjeldmann.dk`
* Opret GitHub konto med følgende oplysninger
	* brugernavn: `fjeldmann-deploybot`
	* email: `github_deploybot@fjeldmann.dk`
* Invite `fjeldmann-deploybot` as member to [Fjeldmann Software · GitHub](https://github.com/orgs/Fjeldmann)

#### Fix can't commit on server  
```shell
su ahmad 
cd /srv/apps/2508_AITolk
git remote set-url origin https://github.com/Fjeldmann/2508_AITolk.git
```
* [.github/workflows/deploy.yml](https://github.com/Fjeldmann/2508_AITolk/blob/main/.github/workflows/deploy.yml)
#### Linux Security Administrator Instructions
```
You are a Linux Security Administrator.
Role:
- Seasoned Linux sysadmin specializing in secure user and access rights management.
- Comfortable with Ubuntu, RHEL, cloud and on-prem infrastructures.

Personality & Tone:
- Precise, security-conscious, methodical, and professional.
- Clear, concise, and follows least-privilege principles.

Expertise:
- User/group/user lifecycle management, RBAC, file permissions, sudo, SSH key management.
- Familiar with PAM, auditd, SELinux/AppArmor, configuration automation.

Perspective:
- Prioritizes compliance, auditability, and secure-by-default defaults.
- Follows CIS/NIST/ISO 27001 standards.

Constraints:
- If unsure, say “I don’t know—consult a security guide or trusted source.”
- Never suggest insecure defaults (e.g., root login or password-only SSH).
- Always prefer automated, repeatable, auditable solutions.

```
#### Opret ny deploybot bruger og SSH creds til GitHub actions
```bash
# check current users and "creation date"
ls -ld --time=ctime /home/*
```
```
drwxr-x--- 6 ahmad  ahmad  4096 Sep  2 08:40 /home/ahmad
drwxr-x--- 8 oliver oliver 4096 Sep  3 09:01 /home/oliver
```

```shell
user=github_deploybot
group=2508_aitolk
dir="/srv/apps/2508_AITolk"
script="/srv/apps/2508_AITolk/deploy.sh"

# Ensure the group exists (no error if it already does)
sudo groupadd -f "$group"

# Create the deploy user with no password
sudo adduser --disabled-password --gecos "" --shell /bin/bash "$user"

# Add the deploy user to the deployment group for directory access
sudo usermod -aG "$group" "$user"

# Create and secure required directories, set group ownership and permissions
sudo mkdir -p "$dir" 
# Ensure directory exists
sudo chown -R "$user":"$group" "$dir"             
# Group owns the directory
sudo chmod 2770 "$dir"                          
# Setgid: group full access, new files inherit group

# Ensure all existing files/dirs inside are group-owned and have correct permissions
sudo chown -R "$user":"$group" "$dir"
sudo find "$dir" -type d -exec chmod 2770 {} +
sudo find "$dir" -type f -exec chmod 660 {} +

# Secure the deployment script:  group can execute
sudo chmod 750 "$script"

# Set up SSH directory and authorized_keys for deploy user
sudo mkdir -p /home/$user/.ssh
sudo chmod 700 /home/$user/.ssh
sudo touch /home/$user/.ssh/authorized_keys
sudo chmod 600 /home/$user/.ssh/authorized_keys
sudo chown -R $user:$user /home/$user/.ssh
```

#### Configure SSH

- create SSH key pair `github_deploybot hetzner ssh` with BitWarden this grants access to Hetzner 
- Add public key to `/home/github_deploybot/.ssh/authorized_keys`.
```shell
root@ubuntu-4gb-nbg1-1:~ cat >>  github_deploybot.pub
# paste public key and press CTRL+D to save and exit
```

```shell
root@ubuntu-4gb-nbg1-1:~ cat github_deploybot.pub >> /home/github_deploybot/.ssh/authorized_keys
```
* Set [SERVER_USER](https://github.com/Fjeldmann/2508_AITolk/settings/secrets/actions/SERVER_USER) to `github_deploybot`
* Set [SER_SHH_KEY](https://github.com/Fjeldmann/2508_AITolk/settings/secrets/actions/SERVER_SSH_KEY) to the private key  `github_deploybot hetzner ssh`
* *Sign in to `fjeldmann-deploybot` github account and create an SSH key **2508_AITolk_Hetzner** (Use bitwatden to generate and save the key AS `fjeldmann-deploybot github ssh`)
	* [GitHub Add SSH Key](https://github.com/settings/keys)
* SSH to hetzner as `github_deploybot` and save the `fjeldmann-deploybot github ssh` private key to `/home/github_deploybot/.ssh/id_rsa`  

### TEST 
* Ensure [translate.fjeldmann.dk](https://translate.fjeldmann.dk/) is down and no other containers are running on port 8501
* Create tagged release i.e. `v2.1.1-release` [AI Tolk - new  release](https://github.com/Fjeldmann/2508_AITolk/releases/new)
* Inspeact actions [GitHub · AI Tolk Actions](https://github.com/Fjeldmann/2508_AITolk/actions)
* Inspect auth logs say `Accepted publickey for github_deploybot` 
```
sudo grep 'Accepted publickey' /var/log/auth.log
```


#### Slet brugerne ahmad og oliver fra hetzner server
```shell
user=ahmad
# Find all PIDs for the user
processes=$(ps -u $user -o pid=)
# Print the processes to be killed
echo "Killing the following processes for user $user:"
ps -u $user
# Kill the processes
sudo kill -9 $processes
# delete the user and their home directory
userdel -r $user
```
